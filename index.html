<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peta GPS Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
  body { margin:0; padding:0; font-family:Arial, sans-serif; }
  #map { height: 100vh; width: 100%; }
  .label-marker {
    background:#007bff;
    color:white;
    padding:2px 5px;
    border-radius:5px;
    font-size:12px;
    white-space:nowrap;
  }
</style>
</head>
<body>
<div id="map"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

// ðŸ”‘ Ganti config sesuai project Firebase-mu
const firebaseConfig = {
  apiKey: "AIzaSyDScne0riHEgvTsn11HkvzD04QVJFqLQ34",
  authDomain: "gps-wm.firebaseapp.com",
  databaseURL: "https://gps-wm-default-rtdb.firebaseio.com/",
  projectId: "gps-wm",
  storageBucket: "gps-wm.appspot.com",
  messagingSenderId: "681165326569",
  appId: "1:681165326569:web:bcfa5e482f47321a5a4878",
  measurementId: "G-6CS8SPQ37F"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Inisialisasi peta
let map = L.map('map').setView([0,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

let markers = {};
let tracks = {};
let positions = {};
let warna = ["red","blue","green","purple","orange","brown"];

// Nama random biar gampang tes
let username = "User" + Math.floor(Math.random()*100);

// Mulai tracking GPS user ini
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    let lat = pos.coords.latitude;
    let lng = pos.coords.longitude;
    set(ref(db,"users/"+username), { lat, lng, time: Date.now() });
  }, err => console.error(err), { enableHighAccuracy:true });
} else {
  alert("GPS tidak tersedia");
}

// Update realtime semua user
onValue(ref(db,"users"), snap => {
  let data = snap.val();
  if (!data) return;

  for (let u in data) {
    let {lat, lng} = data[u];

    // Marker dengan nama
    if (!markers[u]) {
      markers[u] = L.marker([lat,lng], {
        icon: L.divIcon({ className:"label-marker", html:u })
      }).addTo(map);
      map.setView([lat,lng], 15);
    } else {
      markers[u].setLatLng([lat,lng]);
    }

    // Simpan posisi untuk track
    if (!positions[u]) positions[u] = [];
    positions[u].push([lat,lng]);

    // Gambar ulang jalur
    if (tracks[u]) map.removeLayer(tracks[u]);
    let col = warna[Object.keys(markers).indexOf(u) % warna.length];
    tracks[u] = L.polyline(positions[u], {color:col}).addTo(map);
  }
});
</script>
</body>
</html>
